
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://monarch-initiative.github.io/monarch-ingest/tutorials/test-ingest/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.0">
    
    
      
        <title>Test - Monarch Ingest</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Monarch Ingest" class="md-header__button md-logo" aria-label="Monarch Ingest" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Monarch Ingest
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Test
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Monarch Ingest" class="md-nav__button md-logo" aria-label="Monarch Ingest" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Monarch Ingest
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Ingest Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingest Tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Ingest Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configure-ingest/" class="md-nav__link">
        Configure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../add-documentation/" class="md-nav__link">
        Document
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../implement-ingest/" class="md-nav__link">
        Implement
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Test
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Test
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-fixtures" class="md-nav__link">
    Basic fixtures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-map-if-necessary" class="md-nav__link">
    A map, if necessary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixtures-for-test-data" class="md-nav__link">
    Fixtures for test data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixture-for-transforming-a-single-row" class="md-nav__link">
    Fixture for transforming a single row
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-the-basics-of-the-ingest" class="md-nav__link">
    Test the basics of the ingest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-against-an-alternate-row" class="md-nav__link">
    Test against an alternate row
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameterized-tests" class="md-nav__link">
    Parameterized tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next" class="md-nav__link">
    Next
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../validate-output/" class="md-nav__link">
        Validate
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Sources
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Sources" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Sources
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingests/alliance/" class="md-nav__link">
        Alliance of Genome Resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingests/pombase/" class="md-nav__link">
        PomBase
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingests/xenbase/" class="md-nav__link">
        XenBase
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ingests/zfin/" class="md-nav__link">
        ZFIN
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Kozathon
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kozathon" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Kozathon
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kozathon/setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-fixtures" class="md-nav__link">
    Basic fixtures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-map-if-necessary" class="md-nav__link">
    A map, if necessary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixtures-for-test-data" class="md-nav__link">
    Fixtures for test data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixture-for-transforming-a-single-row" class="md-nav__link">
    Fixture for transforming a single row
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-the-basics-of-the-ingest" class="md-nav__link">
    Test the basics of the ingest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-against-an-alternate-row" class="md-nav__link">
    Test against an alternate row
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameterized-tests" class="md-nav__link">
    Parameterized tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next" class="md-nav__link">
    Next
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Test</h1>
                
                <h6 id="testing">Testing</h6>
<p>You may want to start with the test template within <code>source_template</code></p>
<h6 id="basic-fixtures">Basic fixtures</h6>
<p>Initially, set up your basic fixtures, taking care to set the correct source name and location for the transform code.</p>
<pre><code class="language-python">import pytest
from koza.koza_runner import get_translation_table


@pytest.fixture
def tt():
    return get_translation_table(&quot;monarch_ingest/translation_table.yaml&quot;, None)

# This name must match the ingest name in the transform code
@pytest.fixture
def source_name():
    return &quot;something-to-somethingelse&quot;

# This is the location of the transform code
@pytest.fixture
def script():
    return &quot;./monarch_ingest/somethingbase/something2somethingelse.py&quot;
</code></pre>
<h6 id="a-map-if-necessary">A map, if necessary</h6>
<p>Some ingests will depend on one or more maps, that fixture can be set up here. Note that this fixture must return a map of maps, and that the inner maps will map from an ID to a dictionary representing column headers and values. </p>
<p>In the example below, a map is created that maps from a big concatenated natural key (as the ID) for ZP to a single column (called <code>iri</code>) that contains the ZP ID. </p>
<p>This map is then placed into the map cache under the name <code>eqe2zp</code></p>
<pre><code class="language-python">@pytest.fixture
def map_cache():
    eqe2zp = {
        &quot;0-0-ZFA:0000042-PATO:0000638-0-0-0&quot;: {&quot;iri&quot;: &quot;ZP:0004225&quot;},
        &quot;BSPO:0000112-BFO:0000050-ZFA:0000042-PATO:0000638-0-0-0&quot;: {
            &quot;iri&quot;: &quot;ZP:0011243&quot;
        },
        &quot;BSPO:0000000-BFO:0000050-ZFA:0000823-PATO:0000642-BSPO:0000007-BFO:0000050-ZFA:0000823&quot;: {
            &quot;iri&quot;: &quot;ZP:0000157&quot;
        },
    }
    return {&quot;eqe2zp&quot;: eqe2zp}
</code></pre>
<h6 id="fixtures-for-test-data">Fixtures for test data</h6>
<p>Create a fixture that returns a dictionary to represent a single row. As a matter of strategy, this row should probably represent a fairly basic row being ingested. </p>
<p>One trick so that you don't have to manually convert from the imput format to a python dictionary format is to run your ingest with a debugger and set a breakpoint just after a row has been injected. If you want a more specific piece of data, check out conditional breakpoints. </p>
<pre><code class="language-python">@pytest.fixture
def basic_row():
    return {
        &quot;ID&quot;: &quot;341492416&quot;,
        &quot;Gene Symbol&quot;: &quot;pax2a&quot;,
        &quot;Gene ID&quot;: &quot;ZDB-GENE-990415-8&quot;,
         #...
        &quot;Fish Environment ID&quot;: &quot;ZDB-GENOX-041102-1385&quot;,
        &quot;Publication ID&quot;: &quot;ZDB-PUB-970210-19&quot;,
        &quot;Figure ID&quot;: &quot;ZDB-FIG-120307-8&quot;,
    }
</code></pre>
<h6 id="fixture-for-transforming-a-single-row">Fixture for transforming a single row</h6>
<p>This sets up a fixture you can call more than once to independently test different attributes</p>
<pre><code class="language-python">@pytest.fixture
def basic_g2p(mock_koza, source_name, basic_row, script, map_cache, tt):
    return mock_koza(
        source_name,
        iter([basic_row]),
        script,
        map_cache=map_cache,
        translation_table=tt,
    )
</code></pre>
<h6 id="test-the-basics-of-the-ingest">Test the basics of the ingest</h6>
<p>Confirm that entities are created matching the expectations on the row</p>
<pre><code class="language-python"># A simple end-to-end test is to confirm that the IDs are set on
def test_gene(basic_g2p):
    gene = basic_g2p[0]
    assert gene
    assert gene.id == &quot;ZFIN:ZDB-GENE-990415-8&quot;


def test_phenotypic_feature(basic_g2p):
    phenotypic_feature = basic_g2p[1]
    assert phenotypic_feature
    assert phenotypic_feature.id == &quot;ZP:0004225&quot;


def test_association(basic_g2p):
    association = basic_g2p[2]
    assert association
    assert association.subject == &quot;ZFIN:ZDB-GENE-990415-8&quot;
    assert association.object == &quot;ZP:0004225&quot;
    assert association.publications
    assert association.publications[0] == &quot;ZFIN:ZDB-PUB-970210-19&quot;
</code></pre>
<h6 id="test-against-an-alternate-row">Test against an alternate row</h6>
<p>For any branching within the transform code, it's a good idea to test against all of the paths through the code. It's possible to set conditional breakpoints to find real examples in the code that will hit each code path, but it may be more practical to modify the basic row as a new fixture</p>
<p>The example below creates a row with additional columns filled in.</p>
<pre><code class="language-python">@pytest.fixture
def postcomposed(mock_koza, source_name, basic_row, script, map_cache, tt):

    basic_row[&quot;Affected Structure or Process 1 subterm ID&quot;] = &quot;BSPO:0000112&quot;
    basic_row[&quot;Post-composed Relationship ID&quot;] = &quot;BFO:0000050&quot;
    basic_row[&quot;Affected Structure or Process 1 superterm ID&quot;] = &quot;ZFA:0000042&quot;

    return mock_koza(
        source_name,
        iter([basic_row]),
        script,
        map_cache=map_cache,
        translation_table=tt,
    )
</code></pre>
<h6 id="parameterized-tests">Parameterized tests</h6>
<p>Mixing <a href="https://docs.pytest.org/en/6.2.x/parametrize.html">parameterization</a> and fixtures changes the approach a little. In this case it makes more sense to alter the row using a parameter and then create the entities within the same method.  </p>
<p>The test below is intended to confirm that when the tag column has any of the specified values, the row will be ignored (confirmed because no entities are created).</p>
<pre><code class="language-python">@pytest.mark.parametrize(&quot;tag&quot;, [&quot;normal&quot;, &quot;exacerbated&quot;, &quot;ameliorated&quot;])
def test_excluded_tags(mock_koza, source_name, basic_row, script, map_cache, tt, tag):
    basic_row[&quot;Phenotype Tag&quot;] = tag
    entities = mock_koza(
        source_name,
        iter([basic_row]),
        script,
        map_cache=map_cache,
        translation_table=tt,
    )
    assert len(entities) == 0
</code></pre>
<h6 id="next">Next</h6>
<p><a href="../validate-output/">Validate the ingest</a></p>
<p>This is also a good time to circle back and update the documentation.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../implement-ingest/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Implement" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Implement
            </div>
          </div>
        </a>
      
      
        
        <a href="../validate-output/" class="md-footer__link md-footer__link--next" aria-label="Next: Validate" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Validate
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
    
  </body>
</html>